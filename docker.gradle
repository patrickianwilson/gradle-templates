/*
This plugin expects the following project extensions to be defined BEFORE the plugin is applied.

project.ext {
    dockerTag = "welcome:latest"
    dockerFile = "$projectDir/deploy/Dockerfile"
    dockerWorkingDir = "$projectDir/deploy"
}
*/

task assembleDockerImage(type: Exec, dependsOn: "assembleJs") {
    workingDir "$projectDir"
    commandLine 'docker', 'build', '-f', project.dockerFile, '-t', project.dockerTag, project.dockerWorkingDir
    
    standardOutput = new ByteArrayOutputStream()

    ext.output = {
        return standardOutput.toString()
    }


    inputs.file project.dockerFile
    inputs.dir project.dockerWorkingDir

}

assembleDockerImage << {
    String dockerOut = ext.output()
    logger.info "Docker output: " + dockerOut


    (dockerOut =~ "Successfully built ([a-f0-9]+)").findAll {
        discard, image ->
            project.ext.imageId = image;
    }
}




/*
task publishDockerImageToGCR(type: Exec) {
    workingDir "$projectDir"
    commandLine 'docker', 'build', '-f', project.dockerFile, '-t', project.dockerTag, project.dockerWorkingDir
    standardOutput = new ByteArrayOutputStream()

    ext.output = {
        return standardOutput.toString()
    }

    inputs.file "${projectDir}/deploy/Dockerfile"
    inputs.dir "${projectDir}/deploy/stage"
}
*/